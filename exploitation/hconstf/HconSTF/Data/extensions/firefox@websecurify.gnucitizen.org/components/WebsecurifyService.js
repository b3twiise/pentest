var CR=Components.results,CC=Components.classes,CI=Components.interfaces;Components.utils.import("resource://gre/modules/XPCOMUtils.jsm");Components.utils.import("resource://org.gnucitizen.websecurify.firefox/content/mod/weaponryCommon.jsm");Components.utils.import("resource://org.gnucitizen.websecurify.firefox/content/mod/websecurifyCommon.jsm");function WebsecurifyService(){}
WebsecurifyService.prototype={classDescription:"Websecurify Firefox Service",classID:Components.ID("{d341d111-6af2-4330-9202-44179aba7597}"),contractID:"@firefox.websecurify.gnucitizen.org/service;1",QueryInterface:XPCOMUtils.generateQI([CI.nsIObserver]),get wrappedJSObject(){return this},observe:function(a,b,c){"profile-after-change"==b?this.initializeComponent(a,b,c):"profile-before-change"==b?this.deinitializeComponent(a,b,c):"http-on-modify-request"==b?this.observeRequest(a,b,c):("http-on-examine-response"==
b||"http-on-examine-cached-response"==b)&&this.observeResponse(a,b,c)},initializeComponent:function(){var a=CC["@mozilla.org/observer-service;1"].getService(CI.nsIObserverService);a.addObserver(this,"http-on-modify-request",!1);a.addObserver(this,"http-on-examine-response",!1)},deinitializeComponent:function(){var a=CC["@mozilla.org/observer-service;1"].getService(CI.nsIObserverService);a.removeObserver(this,"http-on-modify-request");a.removeObserver(this,"http-on-examine-response")},augmentHttpChannelForCacheBypass:function(a){a.loadFlags|=
CI.nsIRequest.LOAD_BYPASS_CACHE},augmentHttpChannelForRedirectionBypass:function(a){try{var b=a.getResponseHeader("Location");b?(a.setResponseHeader("Location",null,!1),b=b.trim(),b.match(/^https?:\/\//i)?a.setResponseHeader("X-Location-Override-Header",b,!1):a.setResponseHeader("X-Location-Override-Header",a.URI.resolve(b),!1)):a.setResponseHeader("X-Location-Override-Header",null,!1)}catch(c){}},augmentHttpChannelForAuthenticationBypass:function(a){try{var b=a.getResponseHeader("WWW-Authenticate");
b?(a.setResponseHeader("WWW-Authenticate",null,!1),a.setResponseHeader("X-WWW-Authenticate-Override-Header",b,!1)):a.setResponseHeader("X-WWW-Authenticate-Override-Header",null,!1)}catch(c){}},augmentHttpChannelForCorsBypass:function(a){"Access-Control-Allow-Origin,Access-Control-Allow-Credentials,Access-Control-Allow-Methods,Access-Control-Allow-Headers,Access-Control-Expose-Headers,Access-Control-Max-Age".split(",").forEach(function(b){try{var c=a.getResponseHeader(b);c&&a.setResponseHeader("X-"+
b+"-Override-Header",c,!1)}catch(d){}});var b;try{b=a.getRequestHeader("Origin")}catch(c){}var d;try{d=a.getRequestHeader("access-control-request-method")}catch(g){}var e;try{e=a.getRequestHeader("access-control-request-headers")}catch(h){}var f=[];a.visitResponseHeaders({visitHeader:function(a){f.push(a)}});a.setResponseHeader("Access-Control-Allow-Origin",b,!1);a.setResponseHeader("Access-Control-Allow-Credentials","true",!1);a.setResponseHeader("Access-Control-Allow-Methods","GET, POST, PUT, DELETE"+
(d?", "+d:""),!1);a.setResponseHeader("Access-Control-Allow-Headers","X-Websecurify-Request"+(e?", "+e:""),!1);a.setResponseHeader("Access-Control-Expose-Headers",f.join(", "),!1);a.setResponseHeader("Access-Control-Max-Age","30",!1)},isHttpChannelInScope:function(a){if(websecurifyCommon.isUrlInScope(a.URI.spec))return!1;var b;try{b=a.getRequestHeader("Origin")}catch(c){}if(b&&websecurifyCommon.isUrlInScope(b))return!0;if(!weaponryCommon.isXMLHttpRequest(a))return!1;a=weaponryCommon.getChannelWindow(a);
return!a?!1:websecurifyCommon.isUrlInScope(a.document.location)},isInternalHttpChannel:function(a){a=weaponryCommon.getChannelWindow(a);return!a?!1:a instanceof CI.nsIDOMChromeWindow},observeRequest:function(a){var b=null;try{b=a.QueryInterface(CI.nsIHttpChannel)}catch(c){return}this.isHttpChannelInScope(b)&&this.augmentHttpChannelForCacheBypass(b)},observeResponse:function(a){var b=null;try{b=a.QueryInterface(CI.nsIHttpChannel)}catch(c){return}this.isHttpChannelInScope(b)&&(this.augmentHttpChannelForRedirectionBypass(b),
this.augmentHttpChannelForAuthenticationBypass(b),this.isInternalHttpChannel(b)||this.augmentHttpChannelForCorsBypass(b))}};var NSGetFactory=XPCOMUtils.generateNSGetFactory([WebsecurifyService]);
